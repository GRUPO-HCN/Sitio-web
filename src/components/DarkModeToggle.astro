---
/**
 * Elegant dark mode toggle with animated sun/moon icons.
 * Persists preference to localStorage. Defaults to light mode.
 * Uses data-dark-toggle for event delegation (supports multiple instances).
 */
---

<button
  type="button"
  data-dark-toggle
  class="relative inline-flex h-9 w-9 items-center justify-center rounded-lg text-gray-500 transition-colors duration-200 hover:bg-gray-100 hover:text-gray-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-500 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-gray-200"
  aria-label="Cambiar tema"
>
  <!-- Sun icon (visible in dark mode → click to go light) -->
  <svg
    class="dm-icon dm-sun absolute h-5 w-5"
    fill="none"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="currentColor"
    aria-hidden="true"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
    />
  </svg>
  <!-- Moon icon (visible in light mode → click to go dark) -->
  <svg
    class="dm-icon dm-moon absolute h-5 w-5"
    fill="none"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="currentColor"
    aria-hidden="true"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
    />
  </svg>
</button>

<style>
  .dm-icon {
    transition: opacity 0.25s ease, transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* Light mode: show moon, hide sun */
  .dm-moon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }
  .dm-sun {
    opacity: 0;
    transform: rotate(-45deg) scale(0.5);
  }

  /* Dark mode: show sun, hide moon */
  :global(html.dark) .dm-sun {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }
  :global(html.dark) .dm-moon {
    opacity: 0;
    transform: rotate(45deg) scale(0.5);
  }

  @media (prefers-reduced-motion: reduce) {
    .dm-icon {
      transition: opacity 0.15s ease;
    }
    .dm-sun,
    .dm-moon,
    :global(html.dark) .dm-sun,
    :global(html.dark) .dm-moon {
      transform: scale(1) rotate(0deg) !important;
    }
  }
</style>

<script>
  // Event delegation — Astro deduplicates module scripts, runs once.
  // Persists across View Transition navigations.
  document.addEventListener('click', (e: Event) => {
    const target = e.target as HTMLElement;
    if (!target.closest('[data-dark-toggle]')) return;

    const html = document.documentElement;
    html.classList.add('theme-transition');
    html.classList.toggle('dark');
    localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');

    setTimeout(() => html.classList.remove('theme-transition'), 350);
  });
</script>
